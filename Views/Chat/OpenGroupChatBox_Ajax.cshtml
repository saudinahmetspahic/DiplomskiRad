@using WebApp.ViewModels.Chat
@model GroupChatListingMessages_VM

<p class="header-text text-color-black"><i class="fa fa-commenting"></i> @Model.GroupName</p>
<div class="flex-column padding-50 h-100 scroll-allow" id="messagesDiv">

    @foreach (var i in Model.Messages)
    {
        <div class="d-block">
            <div class="@(i.SenderId != Model.UserId ? "background-light margin-right-25 div-align-left text-align-left border-radius-left" : "background-dark margin-left-25 div-align-right text-align-right border-radius-right") w-75 d-inline-block margin-5 padding-20 text-color-white">
                <p class="small-text text-color-darkgray">@i.SenderName @i.SendingDate.ToString("dd/MM/yyyy hh:mm dddd")</p>
                <p> @i.MessageContent</p>
            </div>
        </div>
    }



</div>

<div class="d-block">
    <input placeholder="Write your message.." class="w-75 h-100 padding-5" id="messageInput" /> <button class="btn btn-secondary float-right w-25 h-100" onclick="javascript: SendNewMessage();" id="sendMessageButton">Send <i class="fa fa-level-up"></i></button>
</div>

<script>
   const conn = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub/")
        //.configureLogging(signalR.LogLevel.Information)
        .build();

        document.getElementById("sendMessageButton").disabled = true;

    conn.on("RemovedFromGroup", function (Group, User) {
        alert("Removed -> group=" + Group + " / user=" + User);
    });
    conn.on("AddedToGroup", function (Group, User) {
        alert("Added -> group=" + Group + " / user=" + User);
    });


    conn.on("RecieveMessage", function (Group, Sender, Message) {
        if ("Group_" + '@Model.GroupChatId' != Group)
            return;

        var div = document.createElement("div");
        div.className = "d-block";

        var div2 = document.createElement("div");
        div2.className = "background-light margin-right-25 div-align-left text-align-left border-radius-left";
        if (Sender != '@Model.UserId')
            div2.className = "background-dark margin-left-25 div-align-right text-align-right border-radius-right";
        div2.className += " w-75 d-inline-block margin-5 padding-20 text-color-white";

        var p = document.createElement("p");
        p.className = "small-text text-color-darkgray";
        var today = new Date();
        var day = today.getDay();
        var daylist = ["Sunday", "Monday", "Tuesday", "Wednesday ", "Thursday", "Friday", "Saturday"];
        p.innerHTML = today.getDay() + "/" + today.getMonth() + "/" + today.getFullYear() + " " + today.getHours() + ":" + today.getMinutes() + " " + daylist[day];

        var p2 = document.createElement("p");
        p2.innerHTML = Message;

        div2.appendChild(p);
        div2.appendChild(p2);

        div.appendChild(div2);
        var parent = document.getElementById("messagesDiv");
        parent.appendChild(div);
        parent.scrollTop = parent.scrollHeight;
    });

    conn.start().then(function () {
        document.getElementById("sendMessageButton").disabled = false;
        conn.invoke("AddUserToGroup", "Group_" + '@Model.GroupChatId').catch(function (err) {
            console.log(err.toString());
        });
    }).catch(function (err) {
        console.log(err.toString());
    });

    function SendNewMessage() {
        var messageContent = $("#messageInput").val();
        // $.post("/Chat/SendNewGroupMessage?GroupChatId=" + '@Model.GroupChatId' + "&Message=" + messageContent);
        conn.invoke("SendMessageToGroup", "Group_" + '@Model.GroupChatId', '@Model.UserId', messageContent).catch(function (err) {
            console.log(err.toString());
        });
    }
</script>